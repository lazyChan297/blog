# TCP

## 前置知识
::: tip
标志位说明<br/>
SYN: 发起，发起握手的那一方会携带这个标志码，如果是第一次，SYN=1<br/>
ACK: 确认，回应发起握手那一方携带的标志位，如果是第一次，ACK=1<br/>
FIN: 结束 <br/>
seq: 顺序号码<br/> 
ack: 确认号码
:::
## 三次握手
发起连接前
### 握手过程
#### 第一次握手，客户端发起。
发送的数据有 `SYN = 1`, `seq = x`,

#### 第二次握手，服务端发起。
发送的数据有 `SYN = 1`, `ACK = 1`, `ack = x + 1`, `seq = y`。<br/>
服务端收到发起的信息，且SYN为1确认为第一次建立联机，<br/>
所以向客户端发送了ACK = 1，表示确认联机<br/>
ack为客户端发送的seq+1，也就是x+1，个人理解为这一标志为是确认对方的端口号<br/>
因为一台主机可以有多个客户端向多个服务器发起握手请求，ack是为确认来自哪个端口
seq是为了传递给客户端是服务器哪个端口发起的第二次握手

#### 第三次握手，客户端发起。
发送的数据有 `ACK = 1`, `ack = y + 1`, `seq = x + 1`
客户端收到ACK=1知道了发起建立联机的服务器已经应答，<br/>
所以客户端发送ACK，告知服务器它发来的建立联机已经确认 <br/>
通过服务器发来的ack确认了端口号,是自己的端口发出，<br/>
通过服务器发来的seq知道了服务器的端口号<br/>
所以把自己的seq + 1 再一次发送给服务器，<br />
目的是让服务器知道仍然是刚刚那个发起握手，建立联机的客户端端口发来的确认信息，<br />
因为是第二次发送，所以需要seq + 1

### 只需要三次握手的原因
三次就可以确认双方的收发能力正常，所以三次足矣
- 客户端发送能力: 第一次握手
- 客户端接收能力: 第三次握手
- 服务端发送、接受能力: 第二次握手

## 四次挥手
断开连接前


### 挥手过程
#### 第一次挥手
客户端发起，发送的内容 `FIN = 1`, `seq = x`
客户端告知服务器断开连接，发送`FIN`和表识自己的端口号`seq`

#### 第二次挥手
服务端发起，发送的内容 `ACK = 1`,`seq = y`,`ack = x + 1`
服务端发送`ACK`确认客户端发起的断开连接，<br/>
发送服务端自己的端口号`seq` <br/>
发送`ack`确认客户端来源

#### 第三次挥手
服务器发起，发送的内容 `FIN = 1`, `ACK = 1`, `ack = x + 1`, `seq = j`
当服务器的内容全部发送完成，再一次向客户端发起挥手<br/>
告知客户端，服务器可以断开连接了发送`FIN`，同时把新的seq和上一次的`ack`内容发送,<br/>
个人理解，再一次发送`ack`目的是让客户端确认还是刚刚服务器发送的确认断开连接

#### 第四次挥手
客户端发起，发送的内容 `ACK = 1`,`seq = x + 1`, `ack = j + 1`
客户端告知服务器，已经收到断开连接的请求了，可以断开了

### 为什么需要四次挥手
因为当服务器收到客户端的`FIN`报文时，服务器很可能还有内容没有传输完毕，<br/>
所以需要等服务器再一次发次`FIN`（第三次），<br/>
客户端的应答（第四次）。<br/>
本质上和三次握手确认双方的收发能力正常外，还需要一次是确认双方都发送了`FIN`