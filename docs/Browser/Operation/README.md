# 浏览器运行机制
以用户输入URL为起点到最终页面呈现，分析浏览器的进程和线程之间是如何运作的
## 浏览器架构模式
以chrome为例，采用的是多进程架构模式。<br/>
- **浏览器主进程**，负责用户显示、用户交互、子进程管理、存储功能
- **GPU进程**，负责页面、CSS 3D效果的绘制
- **网络进程**，负责网络资源加载
- **插件进程**，负责运行插件，同时防止插件崩溃导致整个浏览器无法运行所以使用单独的进程来运行
- **渲染进程**，该进程是多线程的，负责将HTML、CSS、JS转换为用户可以与之交互的网页，js的V8引擎，排版的Blink引擎都运行在该线程中
    - js线程
    - GUI绘制线程
    - 事件触发线程
    - 定时器线程
    - 异步请求线程
    - 合成线程
## 工作流程
- **用户输入URL**，浏览器主进程检查无误是合法的IP地址后，调度进程间通信，把URL发送给**网络进程**<br/>
- **网络进程**接收到URL之后开始[DNS查询](/networkAngBrowser/http-dns/)<br/>
- 查询成功后，建立tcp连接过程，浏览器默认为每个域名分配6个tcp连接如果超出该值，则进入等待TCP队列<br/>
- 请求成功后返回资源（html、css、js)
- 浏览器主进程检查当前URL是否与之前打开渲染进程的根域名相同，如果相同复用原来的进程，如果不同开启新的渲染进程<br/>
- **渲染进程**将请求到的资源解析m如果解析过程中，到外链的js或样式表会阻塞解析
    - HTML解析器解析HTML文本构建DOM tree，从左到右从上到下
    - CSS解析器解析样式表构建CSSOM tree，如果有多个选择器则从右到左查询
    - 根据DOM tree和CSSOM tree合成layout tree，计算该树的几何信息，接着对layout tree分层（如果样式中使用了z-index属性）得到一张或多张位图发送给合成线程，提交到合成线程，此后的操作不再阻塞主线程。
- **绘制页面**，合成线程利用GPU将位图绘制，优先绘制可见的和即将可见的节点，最后呈现到屏幕上

## 其它

**解析URL地址**
对URL中有特殊字符或者文字进行编码
- 使用`encodeURIComponent`对`,/?:@&=+$#`转义
- 使用`encodeURI`仅仅对中文处理
```javascript
let url = 'http://www.72lsy.vip?query=携带了中文&num=1+'
// encodeURI只对中文处理，忽略了,/?:@&=+$#
encodeURI(url) 
// http://www.72lsy.vip?query=%E6%90%BA%E5%B8%A6%E4%BA%86%E4%B8%AD%E6%96%87&num=1+
// encodeURIComponent对,/?:@&=+$#进行转义
encodeURIComponent(url) // http%3A%2F%2Fwww.72lsy.vip%3Fquery%3D%E6%90%BA%E5%B8%A6%E4%BA%86%E4%B8%AD%E6%96%87%26num%3D1%2B
```

**DNS预解析**
将其他域名的资源提前解析，例如图片链接通常会使用一个专门的域名来管理，那么可以配置`<link rel="dns-prefetch" href="//pic.xxx.com">`<br/>
如果是https请求，需要额外配置`<meta http-equiv="x-dns-prefetch-control" content="on">`<br/>

**prefetch和preload**
- 如果资源确定在当前页面加载，使用`rel=preload`，这样资源会提前下载减少等待时间，加载优先级会高于link标签的资源的优先级
- 如果资源确定在下一个页面加载，使用`rel=prefetch`，这样资源会在网络空闲时下载

**回流（重排）和重绘**
- 回流：涉及到计算节点的几何信息的**读写**都会触发回流
- 重绘：涉及到节点的外观属性的都会触发重绘

**渲染方向的优化**
- **异步加载资源** script标签使用`async`或`defer`实现异步加载资源，使加载过程不阻塞页面的渲染，不过执行的过程仍然会阻塞
- **优化样式表**样式表下载、解析是会造成页面渲染阻塞的，如果页面有骨架屏或者启动样式，可以将该部分的样式分割，先加载该资源，剩余的样式链接使用`preload`提升它的优先级下载但并不会阻塞页面渲染

**不同资源加载的优先级**
- HTML CSS文件加载优先级最高
- 其次到font字体文件
- 图片资源如果当前在视口出现优先级为High，否则为low
- 异步加载的脚本优先级最低



